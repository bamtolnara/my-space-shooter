<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÌîΩÏÖÄ ÏäàÌÑ∞: ÎßàÏä§ÌÑ∞ÌîºÏä§</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { margin: 0; background: #111; display: flex; justify-content: center; align-items: center; height: 100vh; color: white; overflow: hidden; touch-action: none; font-family: 'Courier New', monospace; }
        canvas { background: #000; border: 2px solid #444; image-rendering: pixelated; box-shadow: 0 0 20px rgba(0,255,255,0.1); max-width: 100%; max-height: 80vh; }
        
        #ui { position: absolute; top: 10px; left: 10px; font-size: 20px; font-weight: bold; z-index: 10; text-shadow: 2px 2px 0 #000; pointer-events: none; }
        #stage-ui { position: absolute; top: 10px; right: 10px; font-size: 20px; font-weight: bold; color: #00e5ff; z-index: 10; text-shadow: 2px 2px 0 #000; pointer-events: none; }

        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #game-over-screen, #victory-screen { display: none; } 
        
        h1 { font-size: 30px; margin-bottom: 20px; text-shadow: 4px 4px 0 #00ffff; text-align: center; }
        
        input { padding: 10px; font-size: 18px; text-align: center; background: #222; border: 2px solid #00e5ff; color: white; font-family: 'Courier New', monospace; margin-bottom: 15px; width: 200px; }
        button { padding: 15px 30px; font-size: 20px; cursor: pointer; background: #00e5ff; border: none; font-family: 'Courier New', monospace; font-weight: bold; box-shadow: 0 0 15px #00e5ff; transition: 0.2s; border-radius: 10px; margin-top: 10px; }
        button:active { transform: scale(0.95); background: white; }
        
        #donateBtn { background: #ff4081; box-shadow: 0 0 15px #ff4081; margin-top: 20px; font-size: 16px; padding: 10px 20px; color: white; }
        
        #select-container { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; max-width: 380px; }
        .plane-select-btn { padding: 8px; font-size: 11px; border: 2px solid transparent; opacity: 0.6; min-width: 70px; display: flex; flex-direction: column; align-items: center; border-radius: 5px; transition: 0.2s; }
        .plane-select-btn.selected { border-color: #fff; opacity: 1.0; transform: scale(1.1); box-shadow: 0 0 15px rgba(255,255,255,0.5); font-weight: bold; }
        .plane-select-btn.locked { background-color: #222 !important; color: #555; cursor: not-allowed; border: 1px solid #444; }

        .ranking-box { background: #111; border: 2px solid #444; padding: 15px; width: 80%; max-width: 300px; margin-bottom: 15px; text-align: left; }
        .ranking-scroll { max-height: 150px; overflow-y: auto; }
        .rank-item { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .rank-1 { color: #ffd700; font-weight: bold; font-size: 16px; text-shadow: 0 0 5px #ffd700; } 
        .rank-2 { color: #c0c0c0; font-weight: bold; } 
        .rank-3 { color: #cd7f32; font-weight: bold; }

        #item-log-container { position: absolute; bottom: 10px; left: 10px; width: 250px; height: 150px; pointer-events: none; z-index: 20; display: flex; flex-direction: column-reverse; overflow: hidden; }
        .log-entry { font-size: 14px; font-weight: bold; margin-top: 5px; text-shadow: 1px 1px 0 #000; animation: fadeOutLog 4s forwards; }
        @keyframes fadeOutLog { 0% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }
        
        #warning-msg { display: none; position: absolute; top: 30%; width: 100%; text-align: center; font-size: 40px; color: red; font-weight: bold; text-shadow: 0 0 10px red; animation: blink 0.5s infinite; pointer-events: none; z-index: 50; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }
        #stage-msg { display: none; position: absolute; top: 40%; width: 100%; text-align: center; font-size: 50px; color: #00e5ff; font-weight: bold; text-shadow: 0 0 20px cyan; animation: fadeOut 3s forwards; pointer-events: none; z-index: 50; }
        @keyframes fadeOut { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(1.5); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="ui">SCORE: <span id="score">0</span></div>
    <div id="stage-ui">STAGE 1</div>
    <div id="item-log-container"></div>
    <div id="warning-msg">‚ö† WARNING ‚ö†<br>BOSS APPROACHING</div>
    <div id="stage-msg">STAGE 1 START</div>
    
    <div id="start-screen" class="screen">
        <h1 style="color:#00e5ff; text-shadow: 0 0 15px #0000ff;">üöÄ PIXEL SHOOTER</h1>
        <div class="ranking-box">
            <div style="text-align:center; margin-bottom:10px; color:#aaa;">üëë TOP 3 RANKING</div>
            <div id="start-ranking-list" style="text-align:center; color:#666;">Îû≠ÌÇπ Î°úÎî©Ï§ë...</div>
        </div>
        <div style="margin-bottom: 5px; color: #fff; font-weight:bold; font-size:14px;">‚ñº Í∏∞Ï≤¥ ÏÑ†ÌÉù (Ìï¥Í∏à ÏãúÏä§ÌÖú) ‚ñº</div>
        <div id="select-container"></div>
        <input type="text" id="username" placeholder="ÎãâÎÑ§ÏûÑ" maxlength="6">
        <button id="startBtn">GAME START</button>
        <button id="donateBtn">‚òï Í∞úÎ∞úÏûê ÌõÑÏõê (Î≥¥ÎÑàÏä§)</button>
        <div style="margin-top: 15px; font-size: 12px; color: #aaa;">
            ‚ö°[P]ÌååÏõåÏóÖ &nbsp; üí®[S]Ïä§ÌîºÎìú<br>
            üõ°Ô∏è[H]Ïâ¥Îìú &nbsp; &nbsp; üí£[B]Ìè≠ÌÉÑ
        </div>
    </div>

    <div id="game-over-screen" class="screen">
        <h2>GAME OVER</h2>
        <div id="final-score">SCORE: 0</div>
        <div id="unlock-msg" style="color: #ffff00; font-weight: bold; margin-bottom: 10px; font-size: 18px; text-shadow: 0 0 5px orange;"></div>
        <div class="ranking-box ranking-scroll">
            <div style="text-align:center; margin-bottom:5px; color:#aaa;">üèÜ TOP 10</div>
            <div id="gameover-ranking-list" style="text-align:center; color:#666;">Î°úÎî©Ï§ë...</div>
        </div>
        <button id="restartBtn">MAIN MENU</button>
    </div>

    <div id="victory-screen" class="screen">
        <h2 style="color:#ffd700;">MISSION CLEAR!</h2>
        <div id="victory-score">SCORE: 0</div>
        <div class="ranking-box ranking-scroll">
            <div style="text-align:center; margin-bottom:5px; color:#aaa;">üèÜ TOP 10</div>
            <div id="victory-ranking-list" style="text-align:center; color:#666;">Î°úÎî©Ï§ë...</div>
        </div>
        <button id="victoryBtn">MAIN MENU</button>
    </div>

    <canvas id="gameCanvas" width="400" height="600"></canvas>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDZrdz1YPykH3cMfYrt1Z18fmqFP66ZPNE",
            authDomain: "pixel-shooter-1e9b9.firebaseapp.com",
            databaseURL: "https://pixel-shooter-1e9b9-default-rtdb.firebaseio.com",
            projectId: "pixel-shooter-1e9b9",
            storageBucket: "pixel-shooter-1e9b9.firebasestorage.app",
            messagingSenderId: "1043130908247",
            appId: "1:1043130908247:web:0688292b8d8bbacd656d12"
        };

        let db;
        let isDbConnected = false;
        try { firebase.initializeApp(firebaseConfig); db = firebase.database(); isDbConnected = true; console.log("DB Ïó∞Í≤∞ ÏÑ±Í≥µ"); } catch (e) { console.log("DB Ïó∞Í≤∞ Ïò§Î•ò:", e); }
        function saveScoreToOnline(name, score) { if (!isDbConnected) return; db.ref('scores').push({ username: name, score: score }); }
        
        function loadOnlineRanking() {
            if (!isDbConnected) return;
            db.ref('scores').orderByChild('score').limitToLast(10).once('value', (snapshot) => {
                const data = snapshot.val(); let rankingArr = []; if (data) { for (let key in data) rankingArr.push(data[key]); rankingArr.sort((a, b) => b.score - a.score); }
                const top3 = rankingArr.slice(0, 3);
                let html3 = top3.length === 0 ? "Í∏∞Î°ù ÏóÜÏùå" : "";
                top3.forEach((rank, index) => { let colorClass = index === 0 ? "rank-1" : index === 1 ? "rank-2" : "rank-3"; html3 += `<div class="rank-item ${colorClass}"><span>${index + 1}. ${rank.username}</span><span>${rank.score}</span></div>`; });
                document.getElementById('start-ranking-list').innerHTML = html3;
                let html10 = rankingArr.length === 0 ? "Í∏∞Î°ù ÏóÜÏùå" : "";
                rankingArr.forEach((rank, index) => { let colorClass = index === 0 ? "rank-1" : index === 1 ? "rank-2" : index === 2 ? "rank-3" : ""; html10 += `<div class="rank-item ${colorClass}"><span>${index + 1}. ${rank.username}</span><span>${rank.score}</span></div>`; });
                document.getElementById('gameover-ranking-list').innerHTML = html10;
                document.getElementById('victory-ranking-list').innerHTML = html10;
            });
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const victoryScreen = document.getElementById('victory-screen');
        const startBtn = document.getElementById('startBtn');
        const restartBtn = document.getElementById('restartBtn');
        const victoryBtn = document.getElementById('victoryBtn');
        const donateBtn = document.getElementById('donateBtn');
        const usernameInput = document.getElementById('username');
        const uiScore = document.getElementById('score');
        const uiStage = document.getElementById('stage-ui');
        const warningMsg = document.getElementById('warning-msg');
        const stageMsg = document.getElementById('stage-msg');
        const itemLogContainer = document.getElementById('item-log-container');
        const selectContainer = document.getElementById('select-container');
        const unlockMsg = document.getElementById('unlock-msg');

        let isGameRunning = false;
        let currentUsername = "Player";
        let startShield = false;
        let selectedPlaneIndex = 0; 
        let now, then, elapsed;
        const fps = 60; const fpsInterval = 1000 / fps;
        const ITEM_DURATION = 10000; 
        const pixelSize = 5;

        const bulletPool = []; const enemyPool = []; const particlePool = []; 

        const STAGE_DATA = {
            1: { triggerScore: 5000,   bossHp: 50,   reward: 35000,  color: '#ff5252', bossType: 'MK1' },
            2: { triggerScore: 45000,  bossHp: 100,  reward: 50000,  color: '#00e5ff', bossType: 'MK1' },
            3: { triggerScore: 100000, bossHp: 200,  reward: 150000, color: '#ffff00', bossType: 'MK2' },
            4: { triggerScore: 260000, bossHp: 500,  reward: 260000, color: '#d50000', bossType: 'MK2' },
            5: { triggerScore: 530000, bossHp: 1000, reward: 300000, color: '#ff9800', bossType: 'MK3' },
            6: { triggerScore: 840000, bossHp: 2000, reward: 400000, color: '#76ff03', bossType: 'MK3' }
        };

        const BOSS_MODELS = {
            'MK1': [ [0,0,0,0,1,1,1,0,0,0,0],[0,0,1,1,1,1,1,1,1,0,0],[0,1,1,1,1,1,1,1,1,1,0],[1,1,0,1,1,1,1,1,0,1,1],[1,1,1,1,1,1,1,1,1,1,1],[0,1,0,1,0,0,0,1,0,1,0],[0,1,0,0,0,0,0,0,0,1,0] ],
            'MK2': [ [0,0,0,0,0,1,0,0,0,0,0],[0,0,0,1,1,1,1,1,0,0,0],[0,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,0,1,0,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1],[0,1,1,0,0,1,0,0,1,1,0],[0,0,1,0,0,0,0,0,1,0,0] ],
            'MK3': [ [1,0,1,1,1,1,1,1,1,0,1],[1,1,1,1,1,1,1,1,1,1,1],[1,1,0,1,1,1,1,1,0,1,1],[1,1,1,1,1,1,1,1,1,1,1],[1,1,1,0,1,1,1,0,1,1,1],[0,1,1,1,1,1,1,1,1,1,0],[0,0,1,1,0,0,0,1,1,0,0] ]
        };

        const PLANES = [
            { name: "BASIC", color: '#b0bec5', speed: 5, reqScore: 0, sprite: [[0,0,0,'#cfd8dc',0,0,0],[0,0,'#cfd8dc','#cfd8dc','#cfd8dc',0,0],[0,'#90a4ae','#cfd8dc','#00e5ff','#cfd8dc','#90a4ae',0],['#90a4ae','#90a4ae','#cfd8dc','#cfd8dc','#cfd8dc','#90a4ae','#90a4ae'],[0,'#eceff1','#455a64','#455a64','#455a64','#eceff1',0],[0,0,'#ff5722',0,'#ff5722',0,0]], missile: { type: 'rect', color: '#ffff00', width: 4, height: 10, speed: -10 } },
            { name: "SPEED", color: '#00e5ff', speed: 8, reqScore: 100000, sprite: [[0,0,0,'#81d4fa',0,0,0],[0,0,'#81d4fa','#00e5ff','#81d4fa',0,0],[0,'#4fc3f7','#00e5ff','#00e5ff','#00e5ff','#4fc3f7',0],['#4fc3f7','#00e5ff','#00e5ff','#e0f7fa','#00e5ff','#00e5ff','#4fc3f7'],[0,'#0288d1','#0288d1','#e0f7fa','#0288d1','#0288d1',0],[0,0,'#ff5722',0,'#ff5722',0,0]], missile: { type: 'rect', color: '#00e5ff', width: 3, height: 15, speed: -14 } },
            { name: "TANK", color: '#ff5252', speed: 4, reqScore: 200000, sprite: [[0,0,'#e53935','#e53935','#e53935',0,0],[0,'#e53935','#ffcdd2','#ffcdd2','#ffcdd2','#e53935',0],['#c62828','#e53935','#ffcdd2','#ffcdd2','#ffcdd2','#e53935','#c62828'],['#c62828','#c62828','#e53935','#e53935','#e53935','#c62828','#c62828'],[0,'#b71c1c','#c62828',0,'#c62828','#b71c1c',0],[0,'#ff5722','#ff5722',0,'#ff5722','#ff5722',0]], missile: { type: 'rect', color: '#ff5252', width: 8, height: 12, speed: -7 } },
            { name: "VIPER", color: '#76ff03', speed: 6, reqScore: 300000, sprite: [[0,0,0,'#b2ff59',0,0,0],[0,0,'#76ff03','#76ff03','#76ff03',0,0],[0,'#64dd17','#76ff03','#ccff90','#76ff03','#64dd17',0],['#33691e','#64dd17','#76ff03','#ccff90','#76ff03','#64dd17','#33691e'],[0,'#33691e','#64dd17','#76ff03','#64dd17','#33691e',0],[0,0,'#76ff03',0,'#76ff03',0,0]], missile: { type: 'rect', color: '#76ff03', width: 5, height: 10, speed: -10 } },
            { name: "VOID", color: '#e040fb', speed: 5, reqScore: 500000, sprite: [[0,0,0,'#e1bee7',0,0,0],[0,0,'#ce93d8','#e040fb','#ce93d8',0,0],[0,'#ab47bc','#e040fb','#f3e5f5','#e040fb','#ab47bc',0],['#8e24aa','#ab47bc','#e040fb','#f3e5f5','#e040fb','#ab47bc','#8e24aa'],[0,'#6a1b9a','#8e24aa',0,'#8e24aa','#6a1b9a',0],[0,'#e040fb',0,0,0,'#e040fb',0]], missile: { type: 'orb', color: '#e040fb', width: 6, height: 6, speed: -9 } }
        ];

        const enemySpriteMono = [[1,0,0,0,0,0,1], [0,1,1,1,1,1,0], [1,1,0,1,0,1,1], [1,1,1,1,1,1,1], [0,1,0,0,0,1,0], [0,1,0,0,0,1,0]];
        const P='#ffff00', S='#00e5ff', H='#00ff00', B='#ff0000';
        const itemSprites = { 'power': [[P,P,P,P,0],[P,0,0,P,0],[P,P,P,P,0],[P,0,0,0,0],[P,0,0,0,0]], 'speed': [[0,S,S,S,0],[S,0,0,0,0],[0,S,S,S,0],[0,0,0,S,0],[S,S,S,0,0]], 'shield':[[H,0,0,0,H],[H,0,0,0,H],[H,H,H,H,H],[H,0,0,0,H],[H,0,0,0,H]], 'bomb':  [[B,B,B,B,0],[B,0,0,B,0],[B,B,B,0,0],[B,0,0,B,0],[B,B,B,B,0]] };

        // ‚òÖ‚òÖ‚òÖ ÏµúÏ†ÅÌôî: ÎèÑÏû•(Image) ÎßåÎì§Í∏∞ Ìï®Ïàò ‚òÖ‚òÖ‚òÖ
        function createCachedSprite(spriteMatrix, colorOverride) {
            const c = document.createElement('canvas');
            c.width = spriteMatrix[0].length * pixelSize;
            c.height = spriteMatrix.length * pixelSize;
            const cx = c.getContext('2d');
            for(let r=0; r<spriteMatrix.length; r++) {
                for(let c=0; c<spriteMatrix[r].length; c++) {
                    let pixel = spriteMatrix[r][c];
                    if(pixel === 0) continue;
                    cx.fillStyle = colorOverride || (typeof pixel === 'string' ? pixel : 'white');
                    cx.fillRect(c * pixelSize, r * pixelSize, pixelSize, pixelSize);
                }
            }
            return c;
        }

        // Ïù¥ÎØ∏ÏßÄ Ï∫êÏãú Ï†ÄÏû•ÏÜå
        const IMG_CACHE = { planes: [], enemies: {}, bosses: {}, items: {} };

        // Í≤åÏûÑ ÏãúÏûë Ï†Ñ Î™®Îì† Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨ ÏÉùÏÑ± (ÌîÑÎ¶¨ Î†åÎçîÎßÅ)
        function initImages() {
            // 1. ÌîåÎ†àÏù¥Ïñ¥ Í∏∞Ï≤¥
            PLANES.forEach(p => {
                p.img = createCachedSprite(p.sprite);
            });
            // 2. Ï†Å (Ïä§ÌÖåÏù¥ÏßÄÎ≥Ñ ÏÉâÏÉÅ)
            for(let i=1; i<=6; i++) {
                IMG_CACHE.enemies[i] = createCachedSprite(enemySpriteMono, STAGE_DATA[i].color);
            }
            // 3. Î≥¥Ïä§ (ÌÉÄÏûÖ & ÏÉâÏÉÅÎ≥Ñ)
            for(let i=1; i<=6; i++) {
                const type = STAGE_DATA[i].bossType;
                const model = BOSS_MODELS[type];
                IMG_CACHE.bosses[i] = createCachedSprite(model, STAGE_DATA[i].color); // Î≥¥Ïä§ ÌÅ¨Í∏∞Îäî 10Î∞∞ ÌôïÎåÄÌï¥ÏÑú Í∑∏Î¶¥ Í≤ÉÏûÑ
            }
            // 4. ÏïÑÏù¥ÌÖú
            for(let key in itemSprites) {
                IMG_CACHE.items[key] = createCachedSprite(itemSprites[key]);
            }
        }
        initImages(); // Ïã§Ìñâ!

        let unlockedPlanes = JSON.parse(localStorage.getItem('unlockedPlanes')) || [0];

        function renderSelectButtons() {
            selectContainer.innerHTML = "";
            PLANES.forEach((plane, index) => {
                const btn = document.createElement('button');
                const isUnlocked = unlockedPlanes.includes(index);
                if (isUnlocked) {
                    btn.innerHTML = `${plane.name}<br><span style="font-size:9px;">READY</span>`;
                    btn.className = 'plane-select-btn';
                    btn.style.backgroundColor = plane.color;
                    btn.onclick = () => { selectedPlaneIndex = index; renderSelectButtons(); playSound('powerup'); };
                } else {
                    btn.innerHTML = `üîí<br><span style="font-size:9px;">${plane.reqScore/10000}Îßå</span>`;
                    btn.className = 'plane-select-btn locked';
                    btn.onclick = () => { alert(`üîí [${plane.name}] Ìï¥Í∏à Ï°∞Í±¥: ${plane.reqScore.toLocaleString()}Ï†ê Îã¨ÏÑ±`); };
                }
                if(index === selectedPlaneIndex) btn.classList.add('selected');
                selectContainer.appendChild(btn);
            });
        }
        renderSelectButtons();

        function checkUnlocks(finalScore) {
            let newUnlock = false;
            let unlockedNames = [];
            PLANES.forEach((plane, index) => {
                if (!unlockedPlanes.includes(index) && finalScore >= plane.reqScore) {
                    unlockedPlanes.push(index);
                    unlockedNames.push(plane.name);
                    newUnlock = true;
                }
            });
            if (newUnlock) {
                localStorage.setItem('unlockedPlanes', JSON.stringify(unlockedPlanes));
                unlockMsg.innerHTML = `üéâ Ï∂ïÌïòÌï©ÎãàÎã§!<br>[ ${unlockedNames.join(', ')} ] Ìï¥Í∏à ÏôÑÎ£å!`;
                renderSelectButtons();
            } else {
                unlockMsg.innerText = "";
            }
        }

        let player = { x: 180, y: 500, width: 35, height: 30, speed: 5, powerLevel: 1, hasShield: startShield, invincible: 0, planeIndex: 0 };
        // Î≥¥Ïä§: ÌîΩÏÖÄ ÏÇ¨Ïù¥Ï¶à 10 (2Î∞∞) -> 11Ïπ∏*10 = 110 width
        let boss = { active: false, x: 0, y: -100, width: 110, height: 70, hp: 0, maxHp: 50, dir: 1 };
        let bullets = [], bossBullets = [], enemies = [], items = [], stars = [], particles = [], keys = {};
        let lastShotTime = 0; const SHOT_DELAY = 150; let animationId; 
        let lastTouchX = null, lastTouchY = null;

        for(let i=0; i<50; i++) stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, size: Math.random()*2+1, speed: Math.random()*3+0.5 });

        window.addEventListener('keydown', (e) => keys[e.code] = true);
        window.addEventListener('keyup', (e) => keys[e.code] = false);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY; }, { passive: false });
        canvas.addEventListener('touchmove', (e) => { if(!isGameRunning) return; e.preventDefault(); const rect = canvas.getBoundingClientRect(); const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height; if(lastTouchX === null) { lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY; return; } let deltaX = (e.touches[0].clientX - lastTouchX) * scaleX; let deltaY = (e.touches[0].clientY - lastTouchY) * scaleY; player.x = Math.max(0, Math.min(canvas.width - player.width, player.x + deltaX)); player.y = Math.max(0, Math.min(canvas.height - player.height, player.y + deltaY)); lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY; }, { passive: false });
        canvas.addEventListener('touchend', () => { lastTouchX = null; lastTouchY = null; });

        function spawnBullet(x, y, dx, dy_offset) {
            const mData = PLANES[player.planeIndex].missile; 
            let b = bulletPool.length > 0 ? bulletPool.pop() : { };
            b.x=x; b.y=y; 
            b.dx=dx||0; 
            b.dy = mData.speed + (dy_offset||0);
            b.width = mData.width; 
            b.height = mData.height;
            b.color = mData.color; 
            b.type = mData.type;   
            b.isDead=false;
            bullets.push(b);
        }

        function createExplosion(x, y, color, count = 8) { for(let i=0; i<count; i++) { let p = particlePool.length > 0 ? particlePool.pop() : { }; p.x=x; p.y=y; p.dx=(Math.random()-0.5)*8; p.dy=(Math.random()-0.5)*8; p.size=Math.random()*4+2; p.life=1.0; p.color=color; particles.push(p); }}
        function spawnEnemy(x, y) { let e = enemyPool.length > 0 ? enemyPool.pop() : { }; e.x=x; e.y=y; e.width=35; e.height=30; e.isDead=false; enemies.push(e); }
        function showItemPopup(text, x, y, color) { const popup = document.createElement('div'); popup.className = 'item-popup'; popup.innerText = text; popup.style.left = (canvas.offsetLeft + x) + 'px'; popup.style.top = (canvas.offsetTop + y) + 'px'; popup.style.color = color; popup.style.position='absolute'; popup.style.fontWeight='bold'; document.body.appendChild(popup); setTimeout(() => popup.remove(), 1000); }
        function addItemLog(text, color) { const log = document.createElement('div'); log.className = 'log-entry'; log.innerText = text; log.style.color = color; itemLogContainer.prepend(log); if(itemLogContainer.children.length>5) itemLogContainer.lastChild.remove(); }
        function showStageTitle(num) { stageMsg.innerText = num === 6 ? "FINAL STAGE" : "STAGE " + num; stageMsg.style.display = 'block'; stageMsg.style.animation = 'none'; stageMsg.offsetHeight; stageMsg.style.animation = 'fadeOut 3s forwards'; }

        let audioCtx;
        function initAudio() { if(!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } if(audioCtx.state === 'suspended') audioCtx.resume(); }
        function playSound(type) {
            if(!audioCtx) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); const now = audioCtx.currentTime;
            if (type === 'shoot') { osc.type = 'square'; osc.frequency.setValueAtTime(800, now); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1); } 
            else if (type === 'explosion') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3); } 
            else if (type === 'boss_hit') { osc.type = 'square'; osc.frequency.setValueAtTime(150, now); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1); } 
            else if (type === 'boss_die') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(300, now); gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0.01, now + 1.5); osc.start(now); osc.stop(now + 1.5); } 
            else if (type === 'powerup') { osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(1200, now + 0.3); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3); } 
            else if (type === 'shield_break') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.5); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5); osc.start(now); osc.stop(now + 0.5); } 
            else if (type === 'bomb') { osc.type = 'square'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(1000, now + 0.5); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5); osc.start(now); osc.stop(now + 0.5); }
            osc.onended = function() { osc.disconnect(); gain.disconnect(); };
        }

        function startGame() {
            score = 0; stage = 1; uiScore.innerText = score; uiStage.innerText = "STAGE 1";
            player = { x: canvas.width/2 - 17, y: canvas.height - 100, width: 35, height: 30, speed: PLANES[selectedPlaneIndex].speed, powerLevel: 1, hasShield: startShield, invincible: 0, planeIndex: selectedPlaneIndex };
            if(startShield) { addItemLog("üíñ ÌõÑÏõê Í∞êÏÇ¨: Ïâ¥Îìú ÏãúÏûë!", "#ff4081"); }
            bullets = []; bossBullets = []; enemies = []; items = []; particles = []; keys = {};
            boss.active = false; boss.y = -100;
            warningMsg.style.display = 'none'; itemLogContainer.innerHTML = "";
            isGameRunning = true; showStageTitle(1); then = Date.now(); gameLoop();
        }

        function hitPlayer() {
            if(Date.now() < player.invincible) return;
            if(player.hasShield) {
                player.hasShield = false; player.invincible = Date.now() + 1500;
                playSound('shield_break'); createExplosion(player.x+player.width/2, player.y+player.height/2, '#00ff00', 10);
                addItemLog("üõ°Ô∏è Ïâ¥Îìú ÌååÍ¥¥Îê®! (Î¨¥Ï†Å)", "#ff5252");
            } else {
                isGameRunning = false; createExplosion(player.x+player.width/2, player.y+player.height/2, '#00ffff');
                saveScoreToOnline(currentUsername, score); 
                checkUnlocks(score); 
                setTimeout(() => { cancelAnimationFrame(animationId); document.getElementById('final-score').innerText = "SCORE: " + score; loadOnlineRanking(); gameOverScreen.style.display = 'flex'; }, 1000);
            }
        }

        function goToMainMenu() {
            gameOverScreen.style.display = 'none';
            victoryScreen.style.display = 'none';
            startScreen.style.display = 'flex';
            loadOnlineRanking();
            renderSelectButtons();
        }

        donateBtn.onclick = () => { window.open('https://www.buymeacoffee.com/'); alert("ÌõÑÏõê ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§! (ÌÖåÏä§Ìä∏: Ïù¥Î≤à Ìåê Ïâ¥Îìú Î≥¥ÎÑàÏä§ Ï†ÅÏö©)"); startShield = true; };
        startBtn.onclick = () => { currentUsername = usernameInput.value.trim() || "Player"; startScreen.style.display='none'; initAudio(); startGame(); };
        restartBtn.onclick = goToMainMenu;
        victoryBtn.onclick = goToMainMenu;

        function gameLoop() { animationId = requestAnimationFrame(gameLoop); now = Date.now(); elapsed = now - then; if (elapsed > fpsInterval) { then = now - (elapsed % fpsInterval); update(); draw(); } }

        function update() {
            if(!isGameRunning) return;
            if(keys['ArrowLeft']) player.x = Math.max(0, player.x - player.speed);
            if(keys['ArrowRight']) player.x = Math.min(canvas.width - player.width, player.x + player.speed);
            if(keys['ArrowUp']) player.y = Math.max(0, player.y - player.speed);
            if(keys['ArrowDown']) player.y = Math.min(canvas.height - player.height, player.y + player.speed);

            if(now - lastShotTime > SHOT_DELAY) {
                let bx = player.x + player.width/2; 
                bx -= PLANES[player.planeIndex].missile.width / 2;
                if(player.powerLevel===1) spawnBullet(bx, player.y, 0, 0);
                else if(player.powerLevel===2) { spawnBullet(bx-10, player.y, -1, 0); spawnBullet(bx+10, player.y, 1, 0); }
                else { spawnBullet(bx, player.y, 0, 0); spawnBullet(bx-10, player.y, -2, 0); spawnBullet(bx+10, player.y, 2, 0); }
                playSound('shoot'); lastShotTime = now;
            }

            if(player.powerLevel > 1 && now > player.powerTime) { player.powerLevel--; player.powerTime = now + ITEM_DURATION; addItemLog(`üîª POWER DOWN`, '#888'); }
            if(player.speed > PLANES[player.planeIndex].speed && now > player.speedTime) { player.speed = PLANES[player.planeIndex].speed; addItemLog("üìâ SPEED NORMAL", '#888'); }
            if(player.hasShield && now > player.shieldTime) { player.hasShield = false; addItemLog("üõ°Ô∏è SHIELD EXPIRED", '#888'); }

            const currentStageData = STAGE_DATA[stage] || STAGE_DATA[6];
            if(!boss.active) {
                if(score >= currentStageData.triggerScore) { boss.active = true; boss.hp = currentStageData.bossHp; boss.maxHp = boss.hp; boss.y = -70; boss.x = canvas.width/2 - 45; warningMsg.style.display = 'block'; setTimeout(()=>warningMsg.style.display='none', 3000); } 
                else if(Math.random() < 0.03 + (stage*0.01)) { spawnEnemy(Math.random()*(canvas.width-35), -30); }
            }
            if(boss.active) {
                if(boss.y < 50) boss.y++; else { boss.x += 2 * boss.dir; if(boss.x <= 0 || boss.x + boss.width >= canvas.width) boss.dir *= -1; 
                if(Math.random() < 0.03) { 
                    let angle = Math.atan2(player.y - (boss.y+boss.height), player.x - (boss.x+boss.width/2)); 
                    let speed = (stage >= 4) ? 10 : 5; 
                    if(stage === 3 || stage === 5) { bossBullets.push({x:boss.x+boss.width/2, y:boss.y+boss.height, width:10, height:20, dx:Math.cos(angle)*speed, dy:Math.sin(angle)*speed}); bossBullets.push({x:boss.x+boss.width/2, y:boss.y+boss.height, width:10, height:20, dx:Math.cos(angle-0.3)*speed, dy:Math.sin(angle-0.3)*speed}); bossBullets.push({x:boss.x+boss.width/2, y:boss.y+boss.height, width:10, height:20, dx:Math.cos(angle+0.3)*speed, dy:Math.sin(angle+0.3)*speed}); } 
                    else if(stage === 6) { for(let k=0; k<5; k++) { let rndAng = Math.random() * Math.PI; bossBullets.push({x:boss.x+boss.width/2, y:boss.y+boss.height, width:8, height:8, dx:Math.cos(rndAng)*speed*1.5, dy:Math.sin(rndAng)*speed*1.5}); } }
                    else { bossBullets.push({x:boss.x+boss.width/2, y:boss.y+boss.height, width:10, height:20, dx:Math.cos(angle)*speed, dy:Math.sin(angle)*speed}); }
                }}
                if(player.x < boss.x + boss.width && player.x + player.width > boss.x && player.y < boss.y + boss.height && player.y + player.height > boss.y) hitPlayer();
            }
            for(let i=bullets.length-1; i>=0; i--) {
                let b = bullets[i]; b.y += b.dy; b.x += b.dx; if(b.y < -20 || b.x < -20 || b.x > canvas.width+20) { bulletPool.push(b); bullets.splice(i, 1); continue; }
                if(boss.active && b.x<boss.x+boss.width && b.x+b.width>boss.x && b.y<boss.y+boss.height && b.y+b.height>boss.y) {
                    bulletPool.push(b); bullets.splice(i, 1); boss.hp--; playSound('boss_hit'); createExplosion(b.x, b.y, '#fff', 3); if(Math.random()<0.05) items.push({x:boss.x+45, y:boss.y+70, width:25, height:25, type:['power','speed','shield','bomb'][Math.floor(Math.random()*4)], isDead:false});
                    if(boss.hp<=0) { boss.active=false; score += currentStageData.reward; uiScore.innerText=score; playSound('boss_die'); createExplosion(boss.x+45, boss.y+35, '#e040fb', 50); enemies.forEach(e => enemyPool.push(e)); enemies=[]; bossBullets=[]; bullets.forEach(b => bulletPool.push(b)); bullets=[]; if(stage<6) { stage++; showStageTitle(stage); } else { isGameRunning=false; saveScoreToOnline(currentUsername, score); checkUnlocks(score); document.getElementById('victory-score').innerText = "SCORE: " + score; loadOnlineRanking(); victoryScreen.style.display='flex'; } break; } continue;
                }
                let hit = false; for(let j=enemies.length-1; j>=0; j--) { let e = enemies[j]; if(b.x<e.x+e.width && b.x+b.width>e.x && b.y<e.y+e.height && b.y+b.height>e.y) { hit = true; enemyPool.push(e); enemies.splice(j, 1); score+=100; uiScore.innerText=score; playSound('explosion'); createExplosion(e.x+17, e.y+15, '#ff5252'); if(Math.random()<0.15) items.push({x:e.x, y:e.y, width:25, height:25, type:['power','speed','shield','bomb'][Math.floor(Math.random()*4)], isDead:false}); break; }}
                if(hit) { bulletPool.push(b); bullets.splice(i, 1); }
            }
            for(let i=enemies.length-1; i>=0; i--) { let e = enemies[i]; e.y += (3+stage); if(e.y > canvas.height) { enemyPool.push(e); enemies.splice(i, 1); continue; } if(player.x < e.x + e.width && player.x + player.width > e.x && player.y < e.y + e.height && player.y + player.height > e.y) { enemyPool.push(e); enemies.splice(i, 1); hitPlayer(); }}
            bossBullets.forEach(bb => { bb.x+=bb.dx; bb.y+=bb.dy; if(bb.y>canvas.height) bb.isDead=true; if(player.x < bb.x + bb.width && player.x + player.width > bb.x && player.y < bb.y + bb.height && player.y + player.height > bb.y) { bb.isDead=true; hitPlayer(); }}); bossBullets = bossBullets.filter(bb => !bb.isDead);
            items.forEach(item => { item.y+=2; if(item.y>canvas.height) item.isDead=true; if(!item.isDead && player.x < item.x+item.width && player.x+player.width > item.x && player.y < item.y+item.height && player.y+player.height > item.y) { item.isDead=true; score+=500; uiScore.innerText=score; if(item.type==='power'){ if(player.powerLevel<3) player.powerLevel++; player.powerTime=now+ITEM_DURATION; showItemPopup("POWER UP!", player.x, player.y, '#ff0'); addItemLog(`‚ö° POWER UP`, '#ff0'); } else if(item.type==='speed'){ player.speed=9; player.speedTime=now+ITEM_DURATION; showItemPopup("SPEED UP!", player.x, player.y, '#0ff'); addItemLog("üí® SPEED UP", '#0ff'); } else if(item.type==='shield'){ player.hasShield=true; player.shieldTime=now+ITEM_DURATION; showItemPopup("SHIELD!", player.x, player.y, '#0f0'); addItemLog("üõ°Ô∏è SHIELD", '#0f0'); } else if(item.type==='bomb'){ enemies.forEach(e => enemyPool.push(e)); enemies=[]; bossBullets=[]; if(boss.active) boss.hp-=20; createExplosion(200,300,'#f00',50); showItemPopup("BOOM!", player.x, player.y, '#f00'); playSound('explosion'); } if(item.type!=='bomb') playSound('powerup'); }}); items = items.filter(i => !i.isDead);
            stars.forEach(s => { s.y+=s.speed; if(s.y>canvas.height) s.y=0; });
            for(let i=particles.length-1; i>=0; i--) { let p = particles[i]; p.x += p.dx; p.y += p.dy; p.life -= 0.1; if(p.life <= 0) { particlePool.push(p); particles.splice(i, 1); }}
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white'; stars.forEach(s => ctx.fillRect(s.x, s.y, s.size, s.size));
            particles.forEach(p => { ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.fillRect(p.x, p.y, p.size, p.size); });
            ctx.globalAlpha=1.0;
            
            // ÌîÑÎ¶¨ Î†åÎçîÎßÅÎêú Ïù¥ÎØ∏ÏßÄ Í∑∏Î¶¨Í∏∞ (ÎèÑÏû• Ï∞çÍ∏∞!)
            items.forEach(item => { if(IMG_CACHE.items[item.type]) ctx.drawImage(IMG_CACHE.items[item.type], item.x, item.y); });
            
            if(isGameRunning) {
                if(player.invincible > Date.now() && Date.now()%200 < 100) {} 
                else {
                    // ÌîåÎ†àÏù¥Ïñ¥ Í∏∞Ï≤¥ Í∑∏Î¶¨Í∏∞
                    if(PLANES[player.planeIndex].img) ctx.drawImage(PLANES[player.planeIndex].img, player.x, player.y);
                    if(player.hasShield) { ctx.strokeStyle='#0f0'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(player.x+player.width/2, player.y+player.height/2, 30, 0, Math.PI*2); ctx.stroke(); }
                }
            }
            
            // Ï†Å Í∑∏Î¶¨Í∏∞ (Ïä§ÌÖåÏù¥ÏßÄÎ≥Ñ ÎØ∏Î¶¨ Í∑∏Î†§Îëî Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©)
            // Ïä§ÌÖåÏù¥ÏßÄÍ∞Ä 6ÏùÑ ÎÑòÏñ¥Í∞ÄÎ©¥ 6ÌÉÑ Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©
            const safeStage = Math.min(stage, 6);
            if(IMG_CACHE.enemies[safeStage]) {
                enemies.forEach(e => ctx.drawImage(IMG_CACHE.enemies[safeStage], e.x, e.y));
            }
            
            // Î≥¥Ïä§ Í∑∏Î¶¨Í∏∞
            if(boss.active && IMG_CACHE.bosses[safeStage]) { 
                // Î≥¥Ïä§ Ïù¥ÎØ∏ÏßÄÎäî ÏõêÎûò ÌîΩÏÖÄ ÏÇ¨Ïù¥Ï¶à 5Î∞∞ÏòÄÎçòÍ±∏ 10Î∞∞(2Î∞∞ Îª•ÌäÄÍ∏∞)Ìï¥ÏÑú Í∑∏Î†§Ïïº Ìï®
                // ÏõêÎ≥∏ Ï∫îÎ≤ÑÏä§Îäî pixelSize 5Î°ú Í∑∏Î†§Ïßê. -> scale(2,2) Ìï¥ÏÑú Í∑∏Î¶¨Í∏∞
                ctx.drawImage(IMG_CACHE.bosses[safeStage], boss.x, boss.y, boss.width, boss.height);
                ctx.fillStyle='red'; ctx.fillRect(boss.x, boss.y-15, boss.width, 10); ctx.fillStyle='#0f0'; ctx.fillRect(boss.x, boss.y-15, boss.width*(boss.hp/boss.maxHp), 10); 
            }
            
            bullets.forEach(b => {
                ctx.fillStyle = b.color;
                if(b.type === 'orb') { ctx.beginPath(); ctx.arc(b.x+b.width/2, b.y+b.height/2, b.width/2, 0, Math.PI*2); ctx.fill(); }
                else { ctx.fillRect(b.x, b.y, b.width, b.height); }
            });
            ctx.fillStyle = '#e040fb'; bossBullets.forEach(bb => ctx.fillRect(bb.x, bb.y, bb.width, bb.height));
        }
        loadOnlineRanking();
    </script>
</body>
</html>
