<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÌîΩÏÖÄ ÏäàÌÑ∞: 5Îã®Í≥Ñ Í∞ïÌôî</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Í∏∞Î≥∏ Î†àÏù¥ÏïÑÏõÉ */
        body { 
            margin: 0; background: #050505; 
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; font-family: 'Press Start 2P', cursive; color: white; 
            touch-action: none; overflow-x: hidden; overflow-y: auto;
        }

        #main-layout { display: flex; align-items: flex-start; justify-content: center; gap: 20px; width: 100%; max-width: 1200px; padding: 10px; box-sizing: border-box; }

        /* Ï¢åÏ∏°/Ïö∞Ï∏° Ìå®ÎÑê */
        .side-panel { width: 130px; background: #111; border: 2px solid #333; border-radius: 10px; padding: 15px; display: flex; flex-direction: column; gap: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.8); height: 600px; box-sizing: border-box; }
        .panel-title { color: #888; font-size: 10px; text-align: center; margin-bottom: 5px; border-bottom: 2px solid #444; padding-bottom: 5px; }
        
        .panel-btn {
            background: #222; border: 2px solid #555; color: #fff;
            padding: 10px 0; text-align: center; font-size: 10px; cursor: pointer;
            border-radius: 5px; transition: 0.2s; width: 100%; box-sizing: border-box;
            font-family: 'Press Start 2P', cursive; 
            touch-action: manipulation; margin-bottom: 5px;
            text-shadow: 2px 2px 0 #000;
        }
        .panel-btn:hover { background: #444; border-color: #fff; color: #ffd700; }
        .panel-btn:active { background: #666; transform: translateY(2px); }

        .item-slot { display: flex; flex-direction: column; align-items: center; gap: 3px; opacity: 0.4; transition: 0.2s; font-size: 8px; text-align: center; position: relative; }
        .item-slot.active { opacity: 1.0; text-shadow: 0 0 10px currentColor; transform: scale(1.05); }
        .icon-box { width: 30px; height: 30px; border: 2px solid #555; display: flex; justify-content: center; align-items: center; font-size: 12px; border-radius: 5px; margin-bottom: 2px; }
        
        .bar-container { width: 100%; height: 4px; background: #333; border-radius: 2px; overflow: hidden; margin-top: 2px; display: none; }
        .item-slot.active .bar-container { display: block; }
        .time-bar { height: 100%; width: 100%; transition: width 0.1s linear; }

        .side-panel.right { align-items: center; justify-content: center; opacity: 0.5; }
        .empty-slot { width: 50px; height: 50px; border: 2px dashed #555; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; color: #555; }

        /* Í≤åÏûÑ Ïª®ÌÖåÏù¥ÎÑà */
        #game-container { 
            position: relative; width: 400px; height: 600px; background: #000; 
            box-shadow: 0 0 50px rgba(0, 229, 255, 0.1); 
            border: 2px solid #333; flex-shrink: 0; overflow: hidden; transition: all 0.5s ease; 
            touch-action: none; 
        }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; touch-action: none; }

        .hud-top { 
            position: absolute; top: 10px; left: 0; width: 100%; 
            background: rgba(0, 0, 0, 0.6); border-bottom: 1px solid rgba(255,255,255,0.1); 
            display: flex; justify-content: space-around; align-items: center; 
            padding: 8px 0; z-index: 20; 
        }
        .hud-item { font-size: 10px; color: #fff; text-align: center; }
        .hud-label { color: #aaa; font-size: 8px; margin-bottom: 3px; display: block; }
        .hud-value { font-size: 12px; color: #fff; }
        #ui-score { color: #00e5ff; text-shadow: 0 0 5px #00e5ff; } 
        #ui-coin { color: #ffd700; text-shadow: 0 0 5px #ffd700; }

        .ui-layer { position: absolute; pointer-events: none; width: 100%; height: 100%; top: 0; left: 0; z-index: 10; }
        #msg-ui { position: absolute; top: 40%; width: 100%; text-align: center; font-size: 40px; display: none; text-shadow: 0 0 20px red; color: red; animation: blink 0.5s infinite; }
        #dev-indicator { position: absolute; bottom: 10px; right: 10px; color: #00ff00; font-size: 10px; display: none; z-index: 50; text-shadow: 0 0 5px #00ff00; }
        
        #pause-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(2px);
            z-index: 90; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        #pause-screen h2 { font-size: 30px; color: #fff; margin-bottom: 20px; text-shadow: 0 0 10px #fff; }

        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 100; 
            overflow-y: auto; 
        }
        
        /* Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
        @media (max-width: 800px) {
            body { display: block; padding: 0; margin: 0; height: 100vh; overflow: hidden; }
            #main-layout { padding: 0; width: 100%; height: 100%; gap: 0; flex-direction: column; align-items: center; justify-content: center; }
            #game-container { 
                width: 100vw; height: 100vh; max-width: none; max-height: none; 
                border: none; aspect-ratio: unset; 
                box-shadow: none !important; 
            }
            .side-panel.right, .side-panel.left { display: none; } 

            body.game-running { display: flex; flex-direction: column; justify-content: flex-start; padding-top: 40px; height: auto; min-height: 100vh; overflow-y: auto; }
            body.game-running #main-layout { padding: 10px; gap: 10px; height: auto; }
            body.game-running #game-container { width: 95%; max-width: 400px; height: auto; aspect-ratio: 2 / 3; max-height: 65vh; border: 2px solid #333; }
            body.game-running .side-panel.right { display: flex; order: 2; width: 100%; max-width: 400px; height: auto; flex-direction: row; justify-content: center; gap: 15px; padding: 10px; animation: fadeIn 0.5s; }
            body.game-running .side-panel.left { display: flex; order: 3; width: 100%; max-width: 400px; height: auto; flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px; animation: fadeIn 0.5s; }
            
            .panel-title { display: none; }
            .hud-item { font-size: 8px; }
            .hud-value { font-size: 10px; }
            
            #username { width: 80%; padding: 15px; font-size: 20px; margin-bottom: 20px; }
            #startBtn, #game-over-screen button, #resumeBtn { width: 80%; padding: 20px; font-size: 20px; margin-top: 20px; }
            .ranking-box { width: 90%; margin-bottom: 30px; }
            .panel-btn { width: 80px; height: 40px; font-size: 10px; display: flex; align-items: center; justify-content: center; margin-right: 10px; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1 { 
            font-family: 'Press Start 2P', cursive; font-size: 38px; margin-bottom: 20px; text-align: left; width: 100%; padding-left: 30px; box-sizing: border-box; 
            color: #fff; text-shadow: 4px 4px 0px #00e5ff; line-height: 1.5; white-space: normal; -webkit-text-stroke: 0; animation: none; 
            cursor: pointer; user-select: none;
            touch-action: manipulation; position: relative; z-index: 1001; 
        }

        #game-over-screen h1 { text-align: center; padding-left: 0; font-size: 48px; color: #ff1744; text-shadow: 4px 4px 0 #b71c1c; cursor: default; width: 100%; }
        .ranking-box { width: 85%; background: rgba(10,10,10,0.95); border: 1px solid #444; box-shadow: 0 0 15px rgba(255, 215, 0, 0.1); padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        #start-ranking { overflow-y: visible; }
        #gameover-ranking { max-height: 150px; overflow-y: auto; padding-right: 5px; }
        #gameover-ranking::-webkit-scrollbar { width: 5px; }
        #gameover-ranking::-webkit-scrollbar-thumb { background: #444; border-radius: 5px; }
        .rank-list { font-size: 14px; text-align: left; }
        .rank-item { display: flex; justify-content: space-between; border-bottom: 1px dashed #333; padding: 8px 0; }
        .rank-name { font-family: 'Gulim', 'Íµ¥Î¶º', sans-serif; }
        button { padding: 15px 40px; font-size: 18px; margin-top: 15px; cursor: pointer; background: transparent; color: #00e5ff; border: 2px solid #00e5ff; font-family: inherit; font-weight: bold; border-radius: 5px; box-shadow: 0 0 10px #00e5ff, inset 0 0 10px #00e5ff; text-shadow: 0 0 5px #00e5ff; transition: 0.3s; }
        button:hover { background: #00e5ff; color: #000; box-shadow: 0 0 20px #00e5ff; }
        input { padding: 12px; font-size: 16px; text-align: center; background: #111; border: 2px solid #444; color: white; margin-bottom: 15px; width: 220px; font-family: 'Gulim', sans-serif; }
        #select-container { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; justify-content: center; }
        .plane-btn { width: 45px; height: 45px; border: 2px solid #333; opacity: 0.6; cursor: pointer; display: flex; justify-content: center; align-items: center; background: #000; position: relative; border-radius: 5px; transition: all 0.3s; }
        .plane-btn.selected { border-color: #00e5ff; opacity: 1.0; transform: scale(1.1); box-shadow: 0 0 10px #00e5ff, inset 0 0 10px rgba(0, 229, 255, 0.3); }
        .plane-btn:hover { border-color: #fff; }
        .locked { opacity: 0.3; cursor: not-allowed; filter: grayscale(100%); }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="main-layout">
        <div class="side-panel left">
            <div class="panel-title">ITEMS</div>
            <div id="pause-btn-panel" class="panel-btn">PAUSE</div>
            <div id="slot-P" class="item-slot" style="color: #ffd700;"><div class="icon-box">P</div><div>PWR</div><div id="count-P" class="item-count">x1</div><div class="bar-container"><div id="bar-P" class="time-bar" style="background: #ffd700;"></div></div></div>
            <div id="slot-S" class="item-slot" style="color: #00e5ff;"><div class="icon-box">S</div><div>SPD</div><div id="count-S" class="item-count">x1</div><div class="bar-container"><div id="bar-S" class="time-bar" style="background: #00e5ff;"></div></div></div>
            <div id="slot-F" class="item-slot" style="color: #ff9800;"><div class="icon-box">F</div><div>FAST</div><div class="bar-container"><div id="bar-F" class="time-bar" style="background: #ff9800;"></div></div></div>
            <div id="slot-H" class="item-slot" style="color: #76ff03;"><div class="icon-box">H</div><div>SHD</div><div id="count-H" class="item-count">OFF</div><div class="bar-container"><div id="bar-H" class="time-bar" style="background: #76ff03;"></div></div></div>
            <div id="slot-O" class="item-slot" style="color: #b388ff;"><div class="icon-box">O</div><div>DRN</div><div id="count-O" class="item-count">x0</div></div>
            <div id="slot-B" class="item-slot" style="color: #ff1744;"><div class="icon-box">B</div><div>BMB</div></div>
        </div>

        <div id="game-container">
            <canvas id="gameCanvas"></canvas>
            
            <div id="pause-screen">
                <h2>PAUSED</h2>
                <button id="resumeBtn">RESUME</button>
            </div>

            <div class="hud-top">
                <div class="hud-item"><span class="hud-label">SCORE</span><span id="ui-score" class="hud-value">0</span></div>
                <div class="hud-item"><span class="hud-label">STAGE</span><span id="ui-stage" class="hud-value">1</span></div>
                <div class="hud-item"><span class="hud-label">COIN</span><span id="ui-coin" class="hud-value">0</span></div>
            </div>
            <div class="ui-layer"><div id="msg-ui">WARNING</div><div id="dev-indicator">üî∞ DEV MODE</div></div>
            
            <div id="start-screen" class="screen">
                <h1 id="game-title">PIXEL<br>SHOOTER</h1>
                <div class="ranking-box">
                    <div style="text-align:center; color:#ffd700; margin-bottom:10px; font-size:12px;">üèÜ HALL OF FAME</div>
                    <div id="start-ranking" class="rank-list">LOADING...</div>
                </div>
                <div id="select-container"></div>
                <input type="text" id="username" placeholder="NICKNAME" maxlength="6">
                <button id="startBtn">GAME START</button>
            </div>

            <div id="game-over-screen" class="screen" style="display:none;">
                <h1>GAME<br>OVER</h1>
                <div id="final-score" style="font-size:24px; margin-bottom:20px; color:#fff; text-shadow:0 0 10px #fff;">SCORE: 0</div>
                <div class="ranking-box">
                    <div style="text-align:center; color:#fff; font-size:12px; margin-bottom:10px;">TOP 10 RANKING</div>
                    <div id="gameover-ranking" class="rank-list"></div>
                </div>
                <div id="unlock-msg" style="color:yellow; font-size:12px; margin-bottom:10px;"></div>
                <button onclick="location.reload()">RETRY</button>
            </div>
        </div>

        <div class="side-panel right">
            <div class="panel-title">SKILL</div>
            <div class="empty-slot">?</div><div class="empty-slot" style="opacity:0.3;">?</div><div class="empty-slot" style="opacity:0.3;">?</div>
            <div style="font-size:8px; color:#666; text-align:center; margin-top:5px;">COMING SOON</div>
        </div>
    </div>

    <script>
        const PIXEL = 4;
        const FPS = 60;
        const FPS_INTERVAL = 1000/FPS;
        const GAME_WIDTH = 400;
        const GAME_HEIGHT = 600;
        const ITEM_DURATION = 20000; 

        let isDevMode = false;
        let titleClickCount = 0;
        let isPaused = false; 

        const firebaseConfig = { apiKey: "AIzaSyDZrdz1YPykH3cMfYrt1Z18fmqFP66ZPNE", authDomain: "pixel-shooter-1e9b9.firebaseapp.com", databaseURL: "https://pixel-shooter-1e9b9-default-rtdb.firebaseio.com", projectId: "pixel-shooter-1e9b9", storageBucket: "pixel-shooter-1e9b9.firebasestorage.app", messagingSenderId: "1043130908247", appId: "1:1043130908247:web:0688292b8d8bbacd656d12" };
        let db, isDbConnected = false;
        function initFirebase() { try { if (typeof firebase !== 'undefined' && !firebase.apps.length) { firebase.initializeApp(firebaseConfig); db = firebase.database(); isDbConnected = true; loadRanking(); } } catch (e) { document.getElementById('start-ranking').innerHTML = "OFFLINE"; } }
        function saveScore(name, score) { if (!isDbConnected || isDevMode) return; try { db.ref('scores').push({ username: name || "Player", score: score, date: Date.now() }); } catch(e) {} }
        
        function loadRanking() { 
            if (!isDbConnected) return; 
            try { 
                db.ref('scores').orderByChild('score').limitToLast(10).once('value', (snapshot) => { 
                    const data = snapshot.val(); let list = []; 
                    if (data) { for (let key in data) list.push(data[key]); list.sort((a, b) => b.score - a.score); } 
                    const medals = ['ü•á', 'ü•à', 'ü•â']; const colors = ['#ffd700', '#c0c0c0', '#cd7f32'];
                    const startHTML = list.slice(0, 3).map((item, i) => `<div class="rank-item" style="color:${colors[i]||'white'}"><span class="rank-name">${medals[i]||(i+1)+'.'} ${item.username}</span><span>${item.score.toLocaleString()}</span></div>`).join('');
                    const endHTML = list.map((item, i) => {
                        const medal = medals[i] || (i + 1) + '.'; const color = colors[i] || '#ccc'; const fontSize = i === 0 ? '18px' : '14px'; const bgStyle = i === 0 ? 'background:rgba(255,215,0,0.1);' : '';
                        return `<div class="rank-item" style="color:${color}; font-size:${fontSize}; ${bgStyle}"><span class="rank-name">${medal} ${item.username}</span><span>${item.score.toLocaleString()}</span></div>`;
                    }).join('');
                    document.getElementById('start-ranking').innerHTML = startHTML || "NO DATA"; document.getElementById('gameover-ranking').innerHTML = endHTML || "NO DATA"; 
                }); 
            } catch(e){} 
        }

        const SPRITES = {
            planes: [
                [[0,0,0,0,2,0,0,0,0],[0,0,0,1,2,1,0,0,0],[0,0,1,1,1,1,1,0,0],[0,1,1,3,1,3,1,1,0],[1,1,1,1,3,1,1,1,1],[1,3,0,1,3,1,0,3,1],[0,3,0,0,3,0,0,3,0]], 
                [[0,0,0,0,2,0,0,0,0],[0,0,0,1,2,1,0,0,0],[0,0,0,1,1,1,0,0,0],[0,0,1,1,3,1,1,0,0],[0,1,1,1,3,1,1,1,0],[1,1,0,1,3,1,0,1,1],[1,3,0,0,3,0,0,3,1]], 
                [[0,1,1,1,2,1,1,1,0],[1,1,1,1,2,1,1,1,1],[1,2,1,1,3,1,1,2,1],[1,1,1,3,3,3,1,1,1],[1,1,1,1,3,1,1,1,1],[0,1,1,0,3,0,1,1,0],[0,3,3,0,3,0,3,3,0]], 
                [[0,0,0,0,2,0,0,0,0],[0,0,0,1,2,1,0,0,0],[0,0,1,1,1,1,1,0,0],[0,1,1,1,3,1,1,1,0],[1,1,1,0,3,0,1,1,1],[1,1,0,0,3,0,0,1,1],[1,0,0,0,0,0,0,0,1]], 
                [[0,0,0,0,2,0,0,0,0],[1,0,0,1,2,1,0,0,1],[1,1,0,1,1,1,0,1,1],[0,1,1,1,3,1,1,1,0],[0,0,1,1,3,1,1,0,0],[0,1,1,0,3,0,1,1,0],[1,1,0,0,3,0,0,1,1]], 
                [[0,0,0,2,2,2,0,0,0],[0,0,1,1,2,1,1,0,0],[0,1,1,1,3,1,1,1,0],[1,1,0,1,3,1,0,1,1],[1,3,0,1,3,1,0,3,1],[0,1,0,0,3,0,0,1,0],[0,2,0,0,0,0,0,2,0]], 
                [[0,0,1,1,2,1,1,0,0],[0,1,1,1,2,1,1,1,0],[1,1,1,1,1,1,1,1,1],[1,3,1,1,3,1,1,3,1],[1,3,1,1,3,1,1,3,1],[0,1,1,0,3,0,1,1,0],[0,0,1,0,3,0,1,0,0]], 
                [[0,2,0,0,2,0,0,2,0],[1,1,1,1,1,1,1,1,1],[1,0,1,1,2,1,1,0,1],[0,0,1,3,3,3,1,0,0],[0,1,1,0,3,0,1,1,0],[1,1,0,0,3,0,0,1,1],[2,0,0,0,3,0,0,0,2]], 
                [[0,2,0,0,0,0,0,2,0],[0,1,1,0,0,0,1,1,0],[0,1,1,1,2,1,1,1,0],[0,1,3,1,1,1,3,1,0],[0,1,3,1,1,1,3,1,0],[0,1,1,0,1,0,1,1,0],[0,0,1,0,3,0,1,0,0]], 
                [[0,0,1,0,2,0,1,0,0],[0,1,1,1,2,1,1,1,0],[1,1,2,1,3,1,2,1,1],[1,1,1,1,3,1,1,1,1],[1,3,1,0,3,0,1,3,1],[0,1,1,0,3,0,1,1,0],[0,2,2,0,2,0,2,2,0]]  
            ],
            enemy: [[1,0,0,0,0,0,1],[0,1,1,1,1,1,0],[1,1,0,3,0,1,1],[1,3,1,3,1,3,1],[0,3,0,3,0,3,0],[0,3,0,0,0,3,0]],
            boss: [[0,0,1,1,1,0,0],[0,1,1,2,1,1,0],[1,1,3,1,3,1,1],[1,3,3,1,3,3,1],[0,3,0,3,0,3,0],[1,3,0,0,0,3,1]],
            drone: [[0,2,0],[1,1,1],[1,3,1],[0,3,0]],
            item_P: [[1,0,1,0,1,1,1],[1,0,1,0,1,0,1],[1,0,1,0,1,1,1],[1,0,1,0,1,0,0],[1,1,1,0,1,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]], 
            item_S: [[0,0,0,0,0,0,0],[1,1,0,0,0,1,1],[1,1,1,0,1,1,1],[0,1,1,1,1,1,0],[0,0,1,1,1,0,0],[0,0,0,1,0,0,0],[0,0,0,0,0,0,0]],
            item_H: [[1,1,1,1,1,1,1],[1,0,0,0,0,0,1],[1,0,1,1,1,0,1],[1,0,1,1,1,0,1],[0,1,0,1,0,1,0],[0,0,1,0,1,0,0],[0,0,0,1,0,0,0]],
            item_B: [[0,0,0,1,0,0,0],[0,0,1,1,1,0,0],[0,0,1,2,1,0,0],[0,0,1,2,1,0,0],[0,0,1,2,1,0,0],[0,1,1,3,1,1,0],[0,1,0,3,0,1,0]],
            item_O: [[0,0,1,1,1,0,0],[0,1,1,2,1,1,0],[1,1,0,3,0,1,1],[1,2,3,2,3,2,1],[1,1,0,3,0,1,1],[0,1,1,2,1,1,0],[0,0,1,1,1,0,0]],
            item_F: [[1,1,1,1,1,0,0],[1,0,0,0,0,0,0],[1,1,1,1,0,0,0],[1,0,0,0,0,0,0],[1,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]], 
            
            bullet_basic:  [[1],[1],[1],[1]],
            bullet_rocket: [[1,1,1,1],[1,2,2,1],[1,2,2,1],[1,1,1,1]],
            bullet_beam:   [[1],[1],[1],[1],[1],[1],[1],[1],[1],[1]],
            bullet_plasma: [[0,1,0],[1,2,1],[0,1,0]],
            bullet_dark:   [[2,0,2],[0,2,0],[2,0,2]],
            
            heart: [
                [0,1,0,1,0],
                [1,2,1,2,1],
                [1,2,2,2,1],
                [0,1,2,1,0],
                [0,0,1,0,0]
            ]
        };

        const PLANES = [
            { name: "Basic", speed: 5, req: 0, color: "#e0e0e0", sub: "#00ffff", shade: "#9e9e9e", bullet: "basic", bSpeed: 8 },
            { name: "Speed", speed: 9, req: 50000, color: "#448aff", sub: "#ffff00", shade: "#1565c0", bullet: "beam", bSpeed: 16 },
            { name: "Tank", speed: 4, req: 100000, color: "#ff5252", sub: "#ffc107", shade: "#c62828", bullet: "rocket", bSpeed: 10 },
            { name: "Stealth", speed: 6, req: 150000, color: "#90caf9", sub: "#ffffff", shade: "#42a5f5", bullet: "beam", bSpeed: 16 },
            { name: "X-Wing", speed: 7, req: 200000, color: "#ffab91", sub: "#ff5722", shade: "#d84315", bullet: "basic", bSpeed: 9 },
            { name: "Viper", speed: 8, req: 250000, color: "#69f0ae", sub: "#e040fb", shade: "#00c853", bullet: "plasma", bSpeed: 12 },
            { name: "Bomber", speed: 3, req: 300000, color: "#795548", sub: "#ffeb3b", shade: "#3e2723", bullet: "rocket", bSpeed: 10 },
            { name: "Alien", speed: 7, req: 350000, color: "#b2ff59", sub: "#f44336", shade: "#64dd17", bullet: "plasma", bSpeed: 12 },
            { name: "Twin", speed: 6, req: 400000, color: "#ff4081", sub: "#80d8ff", shade: "#c51162", bullet: "basic", bSpeed: 9 },
            { name: "Crown", speed: 5, req: 450000, color: "#ffd700", sub: "#ffffff", shade: "#ff6f00", bullet: "beam", bSpeed: 16 }
        ];

        const STAGE_COLORS = [
            { main: '#ff5252', shade: '#c62828' }, { main: '#00e5ff', shade: '#00b0ff' }, { main: '#ffff00', shade: '#fbc02d' },
            { main: '#ff1744', shade: '#b71c1c' }, { main: '#ff9100', shade: '#e65100' }, { main: '#76ff03', shade: '#33691e' }
        ];

        const canvas = document.getElementById('gameCanvas'); 
        const ctx = canvas.getContext('2d', { alpha: false }); 
        canvas.width = GAME_WIDTH; canvas.height = GAME_HEIGHT;

        const ATLAS = document.createElement('canvas'); const ATLAS_CTX = ATLAS.getContext('2d'); const SPRITE_MAP = {}; let atlasX = 0;
        let ATLAS_BITMAP = null; 
        ATLAS.width = 3000; ATLAS.height = 200;
        
        function bufferSprite(n, m, c1, c2, c3, s=1) {
            const w = m[0].length*PIXEL*s, h = m.length*PIXEL*s;
            for(let r=0;r<m.length;r++) for(let c=0;c<m[r].length;c++) { const v=m[r][c]; if(v) { ATLAS_CTX.fillStyle=v===1?(c1||'white'):v===2?(c2||'white'):(c3||'gray'); ATLAS_CTX.fillRect(atlasX+c*PIXEL*s, r*PIXEL*s, PIXEL*s, PIXEL*s); } }
            SPRITE_MAP[n] = {x:atlasX, y:0, w:w, h:h}; atlasX+=w+10;
        }
        
        function initAtlas() {
            PLANES.forEach((p, i) => bufferSprite(`plane_${i}`, SPRITES.planes[i], p.color, p.sub, p.shade));
            bufferSprite('drone', SPRITES.drone, '#00ffff', 'white', '#00aaaa');
            STAGE_COLORS.forEach((c, i) => {
                bufferSprite(`enemy_s${i+1}`, SPRITES.enemy, c.main, 'white', c.shade, 1.2); 
                bufferSprite(`boss_s${i+1}`, SPRITES.boss, c.main, 'white', c.shade, 3);
            });
            bufferSprite('enemy_hit', SPRITES.enemy, 'white', 'white', 'white', 1.2);
            bufferSprite('boss_hit', SPRITES.boss, 'white', 'white', 'white', 3);
            bufferSprite('item_P', SPRITES.item_P, '#ffd700', '#ffffff', '#daa520'); 
            bufferSprite('item_S', SPRITES.item_S, '#ffffff', '#e0e0e0', '#cccccc');
            bufferSprite('item_H', SPRITES.item_H, '#2979ff', '#ffffff', '#0d47a1');
            bufferSprite('item_B', SPRITES.item_B, '#d50000', '#ff8a80', '#ff1744');
            bufferSprite('item_O', SPRITES.item_O, '#b388ff', '#ffffff', '#6200ea');
            bufferSprite('item_F', SPRITES.item_F, '#ff9800', '#ffffff', '#e65100');
            bufferSprite('b_basic', SPRITES.bullet_basic, '#ffeb3b', '#fff', '#fbc02d');
            bufferSprite('b_beam', SPRITES.bullet_beam, '#00e5ff', '#fff', '#00b0ff');
            bufferSprite('b_rocket', SPRITES.bullet_rocket, '#ff5252', '#fff', '#c62828');
            bufferSprite('b_plasma', SPRITES.bullet_plasma, '#76ff03', '#fff', '#33691e');
            bufferSprite('b_dark', SPRITES.bullet_dark, '#e040fb', '#fff', '#aa00ff');
            bufferSprite('heart_full', SPRITES.heart, '#cc0000', '#ff0000', '#ffffff', 1); 
            bufferSprite('heart_empty', SPRITES.heart, '#333333', '#555555', '#aaaaaa', 1);

            createImageBitmap(ATLAS).then(bitmap => { ATLAS_BITMAP = bitmap; });
        }
        initAtlas();

        const POOLS = { bullets: createPool(200), bossBullets: createPool(300), enemies: createPool(70), particles: createPool(200), items: createPool(20) };
        function createPool(size) { return Array.from({ length: size }, () => ({ active: false })); }
        function getFromPool(pool) { 
            for(let i=0; i<pool.length; i++) {
                if(!pool[i].active) return pool[i]; 
            }
            return null; 
        }

        let isRunning = false, score = 0, stage = 1, coins = 0;
        let player = { 
            x: 180, y: 500, w: 0, h: 0, speed: 5, power: 1, shield: false, invincible: 0, drones: [], 
            hp: 3, maxHp: 3, 
            timers: { power: 0, speed: 0, shield: 0, fire: 0 }
        };
        let boss=null, stars=[], keys={};
        let lastTime=0, lastShotTime=0;
        let touchX=null, touchY=null, selectedIdx=0, unlocked=[0], currentUsername="Player";
        let playerBaseSpeed = 0;

        const isMobile = window.innerWidth <= 800;
        const STAR_COUNT = isMobile ? 30 : 80; 

        for(let i=0; i<STAR_COUNT; i++) {
            const speed = Math.random() < 0.2 ? Math.random()*20 + 10 : Math.random()*2 + 0.5;
            stars.push({ x: Math.random()*GAME_WIDTH, y: Math.random()*GAME_HEIGHT, w: speed>5?1:2, h: speed>5?Math.random()*30+10:2, speed: speed, color: speed>5?`rgba(255,255,255,${Math.random()*0.3})`:`rgba(255,255,255,${Math.random()*0.8})` });
        }

        function getPos(e) { const r = canvas.getBoundingClientRect(); const t = e.touches ? e.touches[0] : e; return { x: (t.clientX - r.left) * (canvas.width / r.width), y: (t.clientY - r.top) * (canvas.height / r.height) }; }
        canvas.addEventListener('touchstart', e => { e.preventDefault(); const pos = getPos(e); touchX = pos.x; touchY = pos.y; }, {passive: false});
        canvas.addEventListener('touchmove', e => { 
            e.preventDefault(); 
            if(!isRunning || touchX === null) return; 
            const pos = getPos(e);
            const sensitivity = 1.3;
            const deltaX = (pos.x - touchX) * sensitivity;
            const deltaY = (pos.y - touchY) * sensitivity;
            player.x = Math.max(0, Math.min(GAME_WIDTH - player.w, player.x + deltaX)); 
            player.y = Math.max(0, Math.min(GAME_HEIGHT - player.h, player.y + deltaY)); 
            touchX = pos.x; touchY = pos.y; 
        }, {passive: false});
        canvas.addEventListener('touchend', () => { touchX = null; touchY = null; });
        window.addEventListener('keydown', e=>keys[e.code]=true);
        window.addEventListener('keyup', e=>keys[e.code]=false);

        document.getElementById('game-title').addEventListener('click', () => {
            titleClickCount++;
            if(titleClickCount >= 5 && !isDevMode) {
                isDevMode = true;
                unlocked = [0,1,2,3,4,5,6,7,8,9]; 
                renderSelectButtons();
                document.getElementById('dev-indicator').style.display = 'block';
                alert("üî∞ DEV MODE ON üî∞\nÎ¨¥Ï†Å, Ï†ÑÏ≤¥Ìï¥Í∏à, Îû≠ÌÇπÏ†ÄÏû• ÏïàÎê®");
            }
        });

        function renderSelectButtons() {
            const c = document.getElementById('select-container'); c.innerHTML = "";
            
            for(let i=0; i<PLANES.length; i++) {
                const p = PLANES[i];
                const btn = document.createElement('div'); 
                btn.className = 'plane-btn' + (i===selectedIdx ? ' selected' : '') + (unlocked.includes(i) ? '' : ' locked');
                btn.style.borderColor = p.color;
                
                const cvs = document.createElement('canvas'); cvs.width = 40; cvs.height = 40; const ctx = cvs.getContext('2d');
                const matrix = SPRITES.planes[i]; const pixelSize = 4;
                const w = matrix[0].length * pixelSize; const h = matrix.length * pixelSize;
                const offX = (40 - w) / 2; const offY = (40 - h) / 2;
                
                for(let r=0; r<matrix.length; r++) {
                    for(let c=0; c<matrix[r].length; c++) { 
                        const v = matrix[r][c]; 
                        if(v) { ctx.fillStyle = v===1 ? p.color : v===2 ? p.sub : p.shade; ctx.fillRect(offX + c*pixelSize, offY + r*pixelSize, pixelSize, pixelSize); } 
                    }
                }
                btn.appendChild(cvs);
                if(!unlocked.includes(i)) { btn.innerHTML = "<span style='font-size:20px'>üîí</span>"; }
                btn.onclick = () => { if(!unlocked.includes(i)) { alert(`Ìï¥Í∏à: ${p.req.toLocaleString()}Ï†ê`); return; } selectedIdx = i; renderSelectButtons(); };
                c.appendChild(btn);
            }
        }

        window.onload = () => {
            initFirebase(); try { const s = JSON.parse(localStorage.getItem('pixelShooterUnlocks')); if(s) unlocked = s; } catch(e){} renderSelectButtons();
            
            document.getElementById('startBtn').onclick = () => { 
                currentUsername = document.getElementById('username').value.trim() || "Player"; 
                document.getElementById('start-screen').style.display = 'none'; 
                document.body.classList.add('game-running'); 
                try { initAudio(); } catch(e){} 
                startGame(); 
            };
            
            const pauseBtn = document.getElementById('pause-btn-panel');
            const resumeBtn = document.getElementById('resumeBtn');
            pauseBtn.onclick = togglePause;
            resumeBtn.onclick = togglePause;
            
            window.addEventListener('keydown', e => {
                if(e.code === 'Escape' || e.code === 'KeyP') {
                    if(isRunning) togglePause();
                }
            });
        };

        let lastScore = -1, lastStage = -1, lastCoin = -1;
        function updateUI() {
            if (score !== lastScore) {
                document.getElementById('ui-score').innerText = score.toLocaleString();
                lastScore = score;
            }
            if (stage !== lastStage) {
                document.getElementById('ui-stage').innerText = stage;
                lastStage = stage;
            }
            if (coins !== lastCoin) {
                document.getElementById('ui-coin').innerText = coins;
                lastCoin = coins;
            }

            const now = Date.now();
            updateSlot('P', player.timers.power, now);
            updateSlot('S', player.timers.speed, now);
            updateSlot('H', player.timers.shield, now);
            updateSlot('F', player.timers.fire, now);

            document.getElementById('slot-P').classList.toggle('active', player.power > 1);
            document.getElementById('count-P').innerText = 'x' + player.power;

            document.getElementById('slot-O').className = 'item-slot' + (player.drones.length > 0 ? ' active' : '');
            document.getElementById('count-O').innerText = 'x' + player.drones.length;
        }

        function togglePause() {
            if(!isRunning && !isPaused) return; 
            isPaused = !isPaused;
            const pauseScreen = document.getElementById('pause-screen');
            if(isPaused) {
                pauseScreen.style.display = 'flex';
                if(audioCtx && audioCtx.state === 'running') audioCtx.suspend();
            } else {
                pauseScreen.style.display = 'none';
                if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
                loop(0); 
            }
        }

        function updateSlot(id, endTime, now) {
            const el = document.getElementById(`slot-${id}`);
            const bar = document.getElementById(`bar-${id}`);
            if (endTime > now) {
                el.classList.add('active');
                const pct = Math.max(0, (endTime - now) / ITEM_DURATION * 100);
                bar.style.width = pct + '%';
            } else {
                if(id !== 'P') el.classList.remove('active'); 
                bar.style.width = '0%';
            }
        }

        function startGame() {
            isRunning = true; isPaused = false; score = 0; stage = 1; coins = 0;
            const pData = PLANES[selectedIdx]; const sMap = SPRITE_MAP[`plane_${selectedIdx}`];
            playerBaseSpeed = pData.speed;
            player = { 
                ...player, x: 180, y: 450, w: sMap.w, h: sMap.h, 
                speed: pData.speed, color: pData.color, sub: pData.sub, shade: pData.shade, 
                power: 1, invincible: 0, drones: [], bType: `b_${pData.bullet}`, bSpeed: pData.bSpeed, 
                hp: 3, maxHp: 3, shield: false,
                timers: { power: 0, speed: 0, shield: 0, fire: 0 }
            };
            
            const poolKeys = Object.keys(POOLS);
            for(let i=0; i<poolKeys.length; i++) {
                const pool = POOLS[poolKeys[i]];
                for(let j=0; j<pool.length; j++) {
                    pool[j].active = false;
                }
            }

            boss=null; 
            document.getElementById('msg-ui').style.display = 'none';
            document.getElementById('pause-screen').style.display = 'none';
            lastScore = -1; lastStage = -1; lastCoin = -1;
            updateUI(); 
            try { playBgm('game'); } catch(e) {}
            if(window.gameLoopId) cancelAnimationFrame(window.gameLoopId); loop();
        }

        function loop(timestamp) {
            if(!isRunning) return;
            if(isPaused) return; 
            try { const dt = timestamp - lastTime; if(dt >= FPS_INTERVAL) { lastTime = timestamp - (dt % FPS_INTERVAL); update(); draw(); } } catch (e) { console.error(e); }
            window.gameLoopId = requestAnimationFrame(loop);
        }

        function update() {
            const now = Date.now();
            if (player.power > 1 && now > player.timers.power) {
                player.power--;
                if(player.power > 1) player.timers.power = now + ITEM_DURATION; 
            }
            if (now > player.timers.speed) player.speed = playerBaseSpeed;
            if (now > player.timers.shield) player.shield = false; else player.shield = true;

            if(keys['ArrowLeft']) player.x -= player.speed; if(keys['ArrowRight']) player.x += player.speed;
            if(keys['ArrowUp']) player.y -= player.speed; if(keys['ArrowDown']) player.y += player.speed;
            player.x = Math.max(0, Math.min(GAME_WIDTH - player.w, player.x)); player.y = Math.max(0, Math.min(GAME_HEIGHT - player.h, player.y));

            for(let i=0; i<stars.length; i++) {
                const s = stars[i];
                s.y += s.speed; 
                if(s.y > GAME_HEIGHT) { s.y = -s.h; s.x = Math.random() * GAME_WIDTH; }
            }

            const centerX = player.x + (player.w/2), droneW = SPRITE_MAP['drone'].w;
            for(let i=0; i<player.drones.length; i++) {
                const d = player.drones[i];
                const tx = centerX + (i === 0 ? -50 : 50) - (droneW / 2), ty = player.y + 10; 
                d.x += (tx - d.x) * 0.2; d.y += (ty - d.y) * 0.2;
            }

            const isRapid = now < player.timers.fire;
            const fireInterval = isRapid ? 72 : 90;

            if(now - lastShotTime > fireInterval) {
                const cx = player.x + (player.w/2); const sMap = SPRITE_MAP[player.bType]; const bw = sMap.w;
                const mainOffsetY = player.bType === 'b_beam' ? 20 : 0;
                
                if (player.power === 1) {
                    spawnBullet(cx - bw/2, player.y - mainOffsetY);
                } else if (player.power === 2) {
                    spawnBullet(player.x, player.y - mainOffsetY); 
                    spawnBullet(player.x + player.w - bw, player.y - mainOffsetY);
                } else if (player.power >= 3) {
                    spawnBullet(cx - bw/2, player.y - mainOffsetY);
                    spawnBullet(cx - bw/2, player.y - mainOffsetY, -3); 
                    spawnBullet(cx - bw/2, player.y - mainOffsetY, 3);  
                }
                
                const droneOffsetY = player.bType === 'b_beam' ? 20 : 10;
                for(let i=0; i<player.drones.length; i++) {
                    const d = player.drones[i];
                    spawnBullet(d.x + (droneW/2) - bw/2, d.y - droneOffsetY);
                }
                playSound('shoot'); lastShotTime = now;
            }

            let spawnRate = 0.02 + (stage * 0.01);
            if (spawnRate > 0.15) spawnRate = 0.15; 

            if(!boss && Math.random() < spawnRate) {
                const sMap = SPRITE_MAP[`enemy_s${Math.min(stage,6)}`];
                const e = getFromPool(POOLS.enemies);
                if(e) { 
                    e.active = true; 
                    e.x = Math.random()*(GAME_WIDTH-sMap.w); 
                    e.y = -sMap.h; 
                    e.w = sMap.w; 
                    e.h = sMap.h; 
                    e.hp = 1 + Math.floor(stage * 0.8); 
                    e.hit = 0; 
                }
            }

            const reqList = [0, 10000, 50000, 110000, 230000, 470000, 820000]; 
            let bossReq = 0;
            if(stage <= 6) bossReq = reqList[stage];
            else bossReq = 820000 + (stage - 6) * 10000; 

            if(!boss && score >= bossReq) {
                const sMap = SPRITE_MAP[`boss_s${Math.min(stage,6)}`];
                boss = { x: GAME_WIDTH/2 - sMap.w/2, y: -sMap.h, w: sMap.w, h: sMap.h, hp: stage*60, maxHp: stage*60, dir: 1, hit: 0, lastShot: 0, phase: 0 };
                document.getElementById('msg-ui').style.display = 'block'; setTimeout(() => document.getElementById('msg-ui').style.display = 'none', 3000);
            }

            for(let i=0; i<POOLS.bullets.length; i++) {
                const b = POOLS.bullets[i];
                if(!b.active) continue; 
                b.x += (b.vx || 0); 
                b.y += b.vy; 
                if(b.y < -20 || b.x < -20 || b.x > GAME_WIDTH+20) b.active = false; 
            }

            if(boss) {
                if(boss.y < 50) boss.y++; boss.x += boss.dir * (2 + stage*0.2); if(boss.x < 0 || boss.x > GAME_WIDTH - boss.w) boss.dir *= -1;
                const fireRate = Math.max(400, 1000 - (stage * 80)); 
                
                if(Date.now() - boss.lastShot > fireRate) {
                    const bx = boss.x + boss.w/2, by = boss.y + boss.h;
                    
                    if(stage === 1) spawnBossBullet(bx, by, 0, 5);
                    else if(stage === 2) { 
                        spawnBossBullet(bx-15, by, 0, 6); spawnBossBullet(bx, by, 0, 6); spawnBossBullet(bx+15, by, 0, 6); 
                    }
                    else if(stage === 3) { 
                        const a = Math.atan2(player.y-by, (player.x+player.w/2)-bx); 
                        for(let k=-0.2; k<=0.2; k+=0.2) spawnBossBullet(bx, by, Math.cos(a+k)*6, Math.sin(a+k)*6); 
                    }
                    else if(stage === 4) { 
                        for(let i=0; i<5; i++) spawnBossBullet(bx, by, (Math.random()-0.5)*10, Math.random()*5+5);
                    }
                    else if(stage === 5) { 
                        // ‚òÖ‚òÖ‚òÖ 5Îã®Í≥Ñ Í∞ïÌôî (4Î∞ú Î∞úÏÇ¨) ‚òÖ‚òÖ‚òÖ
                        const a = Math.atan2(player.y-by, (player.x+player.w/2)-bx); 
                        spawnBossBullet(bx, by, Math.cos(a-0.2)*10, Math.sin(a-0.2)*10, 'sniper'); 
                        spawnBossBullet(bx, by, Math.cos(a-0.07)*10, Math.sin(a-0.07)*10, 'sniper');
                        spawnBossBullet(bx, by, Math.cos(a+0.07)*10, Math.sin(a+0.07)*10, 'sniper');
                        spawnBossBullet(bx, by, Math.cos(a+0.2)*10, Math.sin(a+0.2)*10, 'sniper');
                    }
                    else { 
                        if (boss.phase % 2 === 0) {
                            if(boss.angle === undefined) boss.angle = 0;
                            for(let i=0; i<12; i++) {
                                const rad = boss.angle + (Math.PI * 2 / 12 * i);
                                const vy = Math.sin(rad) * 8;
                                if (vy > -2) { 
                                    spawnBossBullet(bx, by, Math.cos(rad)*8, vy);
                                }
                            }
                            boss.angle += 0.2; 
                        } else {
                            for(let i=0; i<7; i++) {
                                spawnBossBullet(bx, by, (Math.random()-0.5)*12, Math.random()*5+7);
                            }
                        }
                        boss.phase++; 
                    }
                    boss.lastShot = Date.now();
                }
                if(boss.hit > 0) boss.hit--;
                if(checkColl(player, boss)) hitPlayer();
                
                for(let i=0; i<POOLS.bullets.length; i++) {
                    const b = POOLS.bullets[i];
                    if(b.active && checkColl(b, boss)) {
                        boss.hp--; boss.hit = 5; b.active = false;
                        if(boss.hp <= 0) { 
                            const bonuses = [0, 30000, 50000, 110000, 220000, 330000, 700000];
                            let reward = (stage <= 6) ? bonuses[stage] : 10000;
                            score += reward; 
                            stage++; updateUI(); createParticle(boss.x, boss.y, 50); dropItem(boss.x+boss.w/2, boss.y+boss.h/2, 'O'); boss = null; 
                            for(let j=0; j<POOLS.bossBullets.length; j++) POOLS.bossBullets[j].active = false;
                            playSound('boss_die'); 
                        }
                    }
                }
            }

            for(let i=0; i<POOLS.bossBullets.length; i++) {
                const b = POOLS.bossBullets[i];
                if(!b.active) continue; 
                b.x += b.vx; b.y += b.vy; 
                if(b.y>GAME_HEIGHT || b.y<0 || b.x<0 || b.x>GAME_WIDTH) b.active = false; 
                if(checkColl(player, {x: b.x-5, y: b.y-5, w: 10, h: 10})) hitPlayer(); 
            }

            for(let i=0; i<POOLS.enemies.length; i++) {
                const e = POOLS.enemies[i];
                if(!e.active) continue;
                e.y += 3 + (stage * 0.5); if(e.hit > 0) e.hit--;
                if(e.y > GAME_HEIGHT) { e.active = false; continue; }
                if(checkColl(player, e)) hitPlayer();
                
                for(let j=0; j<POOLS.bullets.length; j++) {
                    const b = POOLS.bullets[j];
                    if(b.active && checkColl(b, e)) {
                        e.hp--; e.hit = 5; b.active = false;
                        if(e.hp <= 0) { 
                            e.active = false; 
                            score += 300; 
                            updateUI(); 
                            createParticle(e.x, e.y, 5); 
                            playSound('explosion'); if(Math.random() < 0.1) dropItem(e.x, e.y); 
                            break; 
                        }
                    }
                }
            }

            for(let i=0; i<POOLS.items.length; i++) {
                const it = POOLS.items[i];
                if(it.active) { 
                    it.y += 3; 
                    if(it.y > GAME_HEIGHT) it.active = false; 
                    else if(checkColl(player, it)) { applyItem(it.type); it.active = false; playSound('powerup'); } 
                }
            }

            for(let i=0; i<POOLS.particles.length; i++) {
                const p = POOLS.particles[i];
                if(p.active) { 
                    if(p.life-- <= 0) p.active = false; 
                    else { p.x += p.vx; p.y += p.vy; }
                }
            }
            
            updateUI();
        }

        function draw() {
            ctx.fillStyle = 'black'; ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            for(let i=0; i<stars.length; i++) {
                const s = stars[i];
                ctx.fillStyle = s.color; ctx.fillRect(s.x | 0, s.y | 0, s.w, s.h); 
            }
            
            for(let i=0; i<POOLS.particles.length; i++) {
                const p = POOLS.particles[i];
                if(p.active) { ctx.fillStyle = p.color; ctx.fillRect(p.x | 0, p.y | 0, p.size, p.size); }
            }

            for(let i=0; i<POOLS.items.length; i++) {
                const it = POOLS.items[i];
                if(it.active) drawAtlas(`item_${it.type}`, it.x | 0, it.y | 0); 
            }

            if(player.invincible > 0) player.invincible--;
            if(player.invincible % 10 < 5) {
                drawAtlas(`plane_${selectedIdx}`, player.x | 0, player.y | 0);
                for(let i=0; i<player.drones.length; i++) {
                    const d = player.drones[i];
                    drawAtlas('drone', d.x | 0, d.y | 0);
                }
                if(player.shield) { ctx.strokeStyle = 'cyan'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc((player.x + (player.w/2)) | 0, (player.y + (player.h/2)) | 0, 40, 0, Math.PI*2); ctx.stroke(); }
            }

            for(let i=0; i<POOLS.enemies.length; i++) {
                const e = POOLS.enemies[i];
                if(e.active) drawAtlas(e.hit > 0 ? 'enemy_hit' : `enemy_s${Math.min(stage,6)}`, e.x | 0, e.y | 0); 
            }

            if(boss) {
                drawAtlas(boss.hit > 0 ? 'boss_hit' : `boss_s${Math.min(stage,6)}`, boss.x | 0, boss.y | 0);
                ctx.fillStyle='red'; ctx.fillRect(boss.x | 0, (boss.y-10) | 0, boss.w, 8); ctx.fillStyle='lime'; ctx.fillRect(boss.x | 0, (boss.y-10) | 0, boss.w*(boss.hp/boss.maxHp), 8);
            }
            
            for(let i=0; i<POOLS.bossBullets.length; i++) {
                const b = POOLS.bossBullets[i];
                if(b.active) { 
                    ctx.fillStyle = b.type === 'sniper' ? '#ff00ff' : '#ff0000'; 
                    const size = b.type === 'sniper' ? 10 : 8; 
                    ctx.fillRect((b.x-size/2) | 0, (b.y-size/2) | 0, size, size); 
                } 
            }

            for(let i=0; i<POOLS.bullets.length; i++) {
                const b = POOLS.bullets[i];
                if(b.active) drawAtlas(b.type, b.x | 0, b.y | 0); 
            }

            const heartW = SPRITE_MAP['heart_full'].w;
            for(let i=0; i<player.maxHp; i++) {
                drawAtlas(i < player.hp ? 'heart_full' : 'heart_empty', 10 + i*(heartW+5), 50);
            }
        }

        function drawAtlas(n, x, y) { 
            const s = SPRITE_MAP[n]; if(!s) return;
            if(ATLAS_BITMAP) { ctx.drawImage(ATLAS_BITMAP, s.x, s.y, s.w, s.h, x, y, s.w, s.h); } 
            else { ctx.drawImage(ATLAS, s.x, s.y, s.w, s.h, x, y, s.w, s.h); }
        }
        function spawnBullet(x, y, vx=0, vy=null) { 
            const b = getFromPool(POOLS.bullets); 
            if(b) { 
                const sMap = SPRITE_MAP[player.bType]; 
                b.active = true; b.x = x; b.y = y; b.w = sMap.w; b.h = sMap.h; 
                b.type = player.bType; 
                b.vx = vx; 
                b.vy = vy !== null ? vy : -player.bSpeed; 
            } 
        }
        function spawnBossBullet(x, y, vx, vy, type) { const b = getFromPool(POOLS.bossBullets); if(b) { b.active = true; b.x = x; b.y = y; b.vx = vx; b.vy = vy; b.type = type; } }
        function createParticle(x, y, count=10) { 
            for(let i=0; i<count; i++) { 
                const p = getFromPool(POOLS.particles); 
                if(p) { p.active = true; p.x = x+20; p.y = y+20; p.vx = (Math.random()-0.5)*10; p.vy = (Math.random()-0.5)*10; p.life = 20; p.color = `hsl(${Math.random()*60},100%,50%)`; p.size = Math.random()*4+2; } 
            } 
        }
        function dropItem(x, y, t) { 
            const it = getFromPool(POOLS.items); 
            if(it) { 
                const types = ['P','S','H','B','O','F']; 
                it.active = true; it.x = x; it.y = y; it.w = 28; it.h = 28; it.type = t || types[Math.floor(Math.random()*types.length)]; 
            } 
        }

        function applyItem(t) { 
            const now = Date.now();
            if(t==='P') { 
                if(player.power < 3) player.power++; 
                player.timers.power = now + ITEM_DURATION; 
            }
            if(t==='S') { player.speed+=2; player.timers.speed = now + ITEM_DURATION; }
            if(t==='H') { player.shield=true; player.timers.shield = now + ITEM_DURATION; }
            if(t==='F') { player.timers.fire = now + ITEM_DURATION; }
            if(t==='B') { 
                for(let i=0; i<POOLS.enemies.length; i++) POOLS.enemies[i].active = false;
                if(boss) boss.hp-=50; 
                createParticle(200,300,50); 
            } 
            if(t==='O') { if(player.drones.length<2) player.drones.push({x:player.x, y:player.y}); else score+=1000; }
            updateUI(); 
        }
        function checkColl(r1, r2) { return r1.x < r2.x + r2.w && r1.x + r1.w > r2.x && r1.y < r2.y + r2.h && r1.y + r1.h > r2.y; }
        
        function hitPlayer() {
            if(isDevMode) return; 
            
            if(player.invincible > 0) return;
            if(player.shield) { 
                player.shield = false; player.timers.shield = 0; 
                player.invincible = 60; playSound('shield'); updateUI(); 
            }
            else {
                player.hp--; 
                player.invincible = 60; 
                updateUI();
                playSound('shield'); 
                createParticle(player.x, player.y, 20); 

                if(player.hp <= 0) { 
                    isRunning = false; saveScore(currentUsername, score); checkUnlock(); try { stopBgm(); playBgm('end'); } catch(e){}
                    document.body.classList.remove('game-running'); 
                    document.getElementById('final-score').innerText = "SCORE: " + score; document.getElementById('game-over-screen').style.display = 'flex';
                    document.getElementById('pause-btn-panel').style.display = 'none'; 
                }
            }
        }
        function checkUnlock() { let newUnlock = false; PLANES.forEach((p, i) => { if(!unlocked.includes(i) && score >= p.req) { unlocked.push(i); newUnlock = true; } }); if(newUnlock) { localStorage.setItem('pixelShooterUnlocks', JSON.stringify(unlocked)); document.getElementById('unlock-msg').innerText = "üéâ Ïã†Í∑ú Í∏∞Ï≤¥ Ìï¥Í∏à!"; } }

        let audioCtx, bgmOscs=[], bgmPlaying=false;
        const MELODIES = { intro: [{f:330,d:0.2}, {f:330,d:0.2}, {f:261,d:0.4}], game: [{f:440,d:0.1},{f:0,d:0.1},{f:523,d:0.1},{f:587,d:0.1}], end: [{f:523,d:0.2},{f:440,d:0.4}] };
        function initAudio() { try { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if(audioCtx.state === 'suspended') audioCtx.resume(); } catch(e){} }
        
        const soundThrottle = {};
        function playSound(t) { 
            try { 
                if(!audioCtx) return; 
                const now = Date.now();
                if(soundThrottle[t] && now - soundThrottle[t] < 80) return;
                soundThrottle[t] = now;

                const o=audioCtx.createOscillator(), g=audioCtx.createGain(); 
                o.connect(g); g.connect(audioCtx.destination); 
                const curr=audioCtx.currentTime; 
                
                if(t==='shoot'){ o.frequency.value=800; o.start(curr); o.stop(curr+0.1); } 
                else { o.type='sawtooth'; o.frequency.value=100; o.start(curr); o.stop(curr+0.3); } 
                g.gain.exponentialRampToValueAtTime(0.01, curr+0.1); 
            } catch(e){} 
        }

        function playBgm(t) { try { if(!audioCtx) initAudio(); stopBgm(); const n=MELODIES[t]; let i=0; bgmPlaying=true; const l=()=>{ if(!bgmPlaying) return; const f=n[i].f; if(f){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.frequency.value=f; g.gain.value=0.05; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+n[i].d); bgmOscs.push(o); } setTimeout(l, n[i].d*1000); i=(i+1)%n.length; }; l(); } catch(e){} }
        function stopBgm() { bgmPlaying=false; bgmOscs.forEach(o=>{try{o.stop()}catch(e){}}); bgmOscs=[]; }
    </script>
</body>
</html>
